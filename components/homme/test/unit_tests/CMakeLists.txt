
SET(UNITTESTER_DIR ${CMAKE_CURRENT_SOURCE_DIR} PARENT_SCOPE)

macro(cxx_unit_test targetname targetsrcs)

SET(EXEC_MODULE_DIR "${CMAKE_CURRENT_BINARY_DIR}/${targetname}_modules")
INCLUDE_DIRECTORIES(${EXEC_MODULE_DIR})

ADD_EXECUTABLE(${targetname} ${UNITTESTER_DIR}/tester.cpp ${targetsrcs})
ADD_TEST(${targetname}_test ${targetname})

TARGET_LINK_LIBRARIES(${targetname} pio timing ${BLAS_LIBRARIES} ${LAPACK_LIBRARIES})

SET_TARGET_PROPERTIES(${targetname} PROPERTIES Fortran_MODULE_DIRECTORY ${EXEC_MODULE_DIR})

IF(UNIX AND NOT APPLE)
  TARGET_LINK_LIBRARIES(${targetname} rt)
ENDIF()

TARGET_INCLUDE_DIRECTORIES(${targetname} PUBLIC "${SRC_SHARE};${SRC_BASE};${SRC_KERNELS_DIR};${UNITTESTER_DIR}")
TARGET_INCLUDE_DIRECTORIES(${targetname} PUBLIC "${PIO_INCLUDE_DIRS};${UTILS_TIMING_DIR}")
TARGET_INCLUDE_DIRECTORIES(${targetname} PUBLIC "${TRILINOS_INSTALL_DIR}/include")

# Variables required for the configuration
SET(CONFIG_DEFINES -DPIO_INTERP -DNC=4 -DNP=4 -DPLEV=5 -DQSIZE_D=1 -DTIMING=1 -D_MPI=1 -D_PRESTART=1 -D_WK_GRAD=1 -DHOMME_QUAD_PREC=1 -DSW_USE_FLAT_ARRAYS=1)

SET (UT_DEBUG_FLAGS "-g O0" CACHE STRING "User defined debug flags for unit tests")
SET (UT_RELEASE_FLAGS "-O3" CACHE STRING "User defined release flags for unit tests")

IF (${CMAKE_BUILD_TYPE} MATCHES "DEBUG")
  TARGET_COMPILE_OPTIONS(${targetname} PUBLIC -Wall ${UT_DEBUG_FLAGS} ${CONFIG_DEFINES})
ELSE()
  TARGET_COMPILE_OPTIONS(${targetname} PUBLIC -Wall ${UT_RELEASE_FLAGS} ${CONFIG_DEFINES})
ENDIF()

link_to_trilinos(${targetname})

endmacro(cxx_unit_test)
